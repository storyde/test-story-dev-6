window.game={compiled:'{"title":"Full Quest (with sidebar)","author":"storyde","content":"","scenes":{"prevScene":{"id":"prevScene","content":{"content":"","type":"paragraph"}},"prevTopScene":{"id":"prevTopScene","content":{"content":"","type":"paragraph"}},"jumpScene":{"id":"jumpScene","content":{"content":"","type":"paragraph"}},"backSpecialScene":{"id":"backSpecialScene","content":{"content":"","type":"paragraph"}},"returnScene":{"id":"returnScene","content":{"content":"","type":"paragraph"}},"credits.inspirations":{"id":"credits.inspirations","options":[{"id":"@credits.back_to_start","title":"Start game."},{"id":"@credits.game_over","title":"End game."}],"content":{"content":"Inspirations for test game.","type":"paragraph"}},"harbour_master_hut.look_map":{"id":"harbour_master_hut.look_map","viewIf":{"$code":"return (Q[\'know_of_map\'] != \\"seen\\");"},"onArrival":[{"$code":"Q[\'know_of_map\'] = \\"seen\\";"}],"content":{"type":"paragraph","content":["The map shows the harbor and the surrounding area. You notice a ",{"type":"emphasis-2","content":"secret passage"}," marked on the map that leads to the ",{"type":"emphasis-2","content":"fortress"},". A symbol of a ",{"type":"emphasis-2","content":"key"}," is marked next to the passage."]}},"harbour_master_hut":{"id":"harbour_master_hut","type":"scene","title":"Harbour Master\'s Hut","newPage":true,"tags":["harbour"],"options":[{"id":"@harbour_master_hut.look_map","title":"Examine the map"}],"content":{"content":"The harbor master\'s hut is a small house near the water\'s edge, where boats and ships come. It\'s a simple building made of wood, with a thatched roof on top. Inside, there are maps on the walls and a big table where the harbor master plans and watches over the harbor.","type":"paragraph"}},"holtext":{"id":"holtext","type":"scene","title":"Context","content":{"content":[{"type":"heading","content":"Context"},{"type":"paragraph","content":"This is the context bar. The context will be displayed here."},{"type":"paragraph","content":"stories fill the air as people eat, drink, and have a good time."},{"type":"paragraph","content":["You are ",{"type":"insert","insert":0},"."]}],"stateDependencies":[{"type":"insert","fn":{"$code":"return (Q[\'hunger\'] || 0);"},"qdisplay":"qhunger"}]}},"init.start_game":{"id":"init.start_game","subtitle":"Should leat to root","goTo":[{"id":"root"}],"content":{"content":"","type":"paragraph"}},"one":{"id":"one","type":"scene","title":"Scene One","newPage":true,"tags":["top"],"content":{"content":"This is the first scene of \\"Dendry-starter-pack\\". From this point, you can add further scenes and choices to flesh out your game.","type":"paragraph"}},"root.emily_date":{"id":"root.emily_date","options":[{"id":"@root.second_choice","title":"the second choice"},{"id":"@root.third_choice","title":"the third choice"}],"content":[{"type":"paragraph","content":["You, well, you ",{"type":"emphasis-1","content":"like"}," liked her. As usual, you never understood why; just some ineffable, irrational feeling deep within you. Well, she was very smart and talented and beautiful. And a kind person once you got past the initial awkwardness. And apparently, she liked you back enough, but wasn\'t so sure about dating back then, with the whole \\"trans and not out as a woman\\" thing."]},{"type":"paragraph","content":"You made a contract with her, or something"}]},"second":{"id":"second","type":"scene","title":"second","newPage":true,"tags":["market"],"content":{"content":"The market is a lively spot where things are bought and sold. Colorful tents line the space with goods like food, clothes, and treasures. People talk and trade, making the place bustling with activity.","type":"paragraph"}},"status":{"id":"status","type":"scene","title":"Qualities","content":{"content":[{"type":"heading","content":"Status"},{"type":"paragraph","content":"This is the status bar. Stats can be displayed here."},{"type":"paragraph","content":["Stat 1: ",{"type":"insert","insert":0}]}],"stateDependencies":[{"type":"insert","fn":{"$code":"return (Q[\'stat_1\'] || 0);"}}]}},"credits.game_over":{"id":"credits.game_over","viewIf":{"$code":"return ((Q[\'time\'] || 0) > 0);"},"gameOver":true,"content":{"content":"","type":"paragraph"}},"init.go_to_credits":{"id":"init.go_to_credits","subtitle":"View credits and inspirations","goTo":[{"id":"credits"}],"content":{"content":"","type":"paragraph"}},"init":{"id":"init","type":"scene","title":"init stats","onArrival":[{"$code":"Q[\'time\'] = 0;\\nQ[\'courage\'] = 8;\\nQ[\'energy\'] = 10;\\nQ[\'despair\'] = 5;\\nQ[\'minus_despair\'] = 0;\\nQ[\'hunger\'] = 10;\\nQ[\'thirst\'] = 10;\\nQ[\'initialized\'] = 1;"}],"newPage":false,"options":[{"id":"@init.start_game","title":"Start game"},{"id":"@init.go_to_credits","title":"Credits"}],"content":{"type":"heading","content":"Test story"}},"root.third_choice":{"id":"root.third_choice","newPage":false,"options":[{"id":"@root.stats","title":"Init"}],"content":{"content":"lets put the third choice here there is no more text here","type":"paragraph"}},"credits.back_to_start":{"id":"credits.back_to_start","viewIf":{"$code":"return ((Q[\'time\'] || 0)===0);"},"goTo":[{"id":"root"}],"content":{"content":"","type":"paragraph"}},"credits":{"id":"credits","type":"scene","title":"Credits","newPage":true,"setBg":"backgrounds/outdoors_1_filtered.jpg","options":[{"id":"@credits.inspirations","title":"Inspirations and related works"},{"id":"@credits.back_to_start","title":"Start game"},{"id":"@credits.game_over","title":"End game"}],"content":[{"type":"paragraph","content":"Test story"},{"type":"paragraph","content":"Developed using dendry by Ian D. Millington, with modifications by Aucchen"},{"type":"paragraph","content":["Thank ",{"type":"emphasis-1","content":"you"}," for playing!"]}]},"root.stats":{"id":"root.stats","title":"Stats","newPage":true,"isSpecial":true,"goTo":[{"id":"init"}],"options":[{"id":"#market"}],"content":{"content":"","type":"paragraph"}},"root.second_choice":{"id":"root.second_choice","title":"second","newPage":true,"tags":["market"],"options":[{"id":"#harbour","title":"Visit the Harbour Master\'s Hut"}],"content":{"content":"The market is a lively spot where things are bought and sold. Colorful tents line the space with goods like food, clothes, and treasures. People talk and trade, making the place bustling with activity.","type":"paragraph"}},"root":{"id":"root","type":"scene","title":"Root Scene","newPage":true,"options":[{"id":"@root.emily_date","title":"I liked her, and she said that we could date after she goes to college, but nothing came of that."}],"content":[{"type":"hrule"},{"type":"heading","content":"Welcome to Holistic Futures"},{"type":"paragraph","content":"In a time not so far into the future, society grapples with the symptoms of the polycrisis—a complex web of social, economic, and environmental challenges. Streets crack under inequality. Climate trembles. Trust fades."},{"type":"hrule"},{"type":"paragraph","content":"You—an explorer by nature, or perhaps just someone who got curious one day—arrive in the middle of it all. A solar-charged wristpad beeps. The air smells like static and regret."},{"type":"paragraph","content":"This is the root scene. The root scene is normally used as a hub: the choices allow you to go to different sections of your story. In shorter works it may just function as the first scene in the game, sending the player off into the tree of choices. If the root scene doesn\'t have any choices that it can display, the game is over."},{"type":"paragraph","content":"Narration: The group gathers around the virtual roundtable."},{"type":"paragraph","content":"Facilitator: Welcome everyone, glad you could make it."},{"type":"paragraph","content":"Me: Hi all! Looking forward to today\'s session."},{"type":"paragraph","content":"Librarian: I can provide resources if needed."},{"type":"paragraph","content":"Archivist: I have access to ancient documents."},{"type":"paragraph","content":"Scholar: Shall we begin with the first topic? a"},{"type":"paragraph","content":"hub: the choices allow you to go to different sections of your story. In shorter works it may just function as the first scene in the game, sending the player off into"},{"type":"paragraph","content":"Historian: I can give some historical context."},{"type":"paragraph","content":"Curator: And I have curated some visuals to share."},{"type":"paragraph","content":"You first encountered her while you were attempting to prepare for a beauty pageant that your parents signed you up for in the junior year of high school. She was at the first meeting for the pageant, not as a contestant but as part of a social experiment. Or something like that. She offered to help you prepare; she was much more amenable to such things. Thus, the two of you became steadily acquainted."},{"type":"paragraph","content":"Emily\'s parents were also part of your parents\' circle. Emily\'s dad, Song Chen, was several levels of academic hierarchy above your mom at their university department. You used to see her at parties much like this one, but not once since high school, until today."},{"type":"paragraph","content":"By the way, she\'s trans. And you don\'t even know if she\'s out yet."}]}},"qualities":{"hunger":{"id":"hunger","type":"quality","name":"hunger","initial":3,"min":0,"max":5,"content":{"content":"","type":"paragraph"}}},"qdisplays":{"qhunger":{"id":"qhunger","type":"qdisplay","content":[{"min":-1,"max":0,"output":": full"},{"min":0,"max":1,"output":": satisfied"},{"min":1,"max":2,"output":": hungry"},{"min":2,"max":3,"output":": famished"},{"min":3,"max":4,"output":": starving"},{"min":4,"max":5,"output":": ravenous"}]}},"tagLookup":{"harbour":{"harbour_master_hut":true},"top":{"one":true},"market":{"second":true,"root.second_choice":true}}}'},function t(e,i,n){function o(r,s){if(!i[r]){if(!e[r]){var c="function"==typeof require&&require;if(!s&&c)return c(r,!0);if(a)return a(r,!0);var h=new Error("Cannot find module '"+r+"'");throw h.code="MODULE_NOT_FOUND",h}var u=i[r]={exports:{}};e[r][0].call(u.exports,function(t){var i=e[r][1][t];return o(i?i:t)},u,u.exports,t,e,i,n)}return i[r].exports}for(var a="function"==typeof require&&require,r=0;r<n.length;r++)o(n[r]);return o}({1:[function(t,e,i){!function(){"use strict";var t=function(t){if(!t)throw new Error("Assertion failed.")},i=function(t,e){for(var i=0;i<t.length;++i)e(t[i])},n=function(t,e){for(var i in t)e(i,t[i])},o=function(){for(var t={},e=0;e<arguments.length;++e){var i=arguments[e];for(var n in i)t[n]=i[n]}return t},a=function(t){var e=typeof t;return"function"===e||t&&"object"===e||!1},r=function(t){t=t.trim();var e=new Function("state","Q",t);return e.source=t,e},s=function(t,e,n){void 0!==t&&i(t,function(t){try{t.call(e,n,n.qualities)}catch(i){}})},c=function(t,e,i,n){var o=e;if(void 0===t)return o;try{o=!!t.call(i,n,n.qualities)}catch(a){}return o},h=function(t,e,i,n){var o=e;if(void 0===t)return o;try{o=t.call(i,n,n.qualities)}catch(a){}return o},u=function(t,e){var i=function(t,e){return a(e)&&void 0!==e.$code?r(e.$code):e};try{var n=JSON.parse(t,i);return e(null,n)}catch(o){return e(o)}},p=function(t){return[{type:"paragraph",content:t}]},l=function(t){return Math.floor(t)===t&&t>=0&&12>=t?["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve"][t]:t.toString()},d=function(t){if(!(Math.floor(t)===t&&t>=0))return t.toString();if(12>=t)return["zeroth","first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth","eleventh","twelfth"][t];if(t=t.toString(),/1[0-9]$/.test(t))return t+"th";var e=t.substr(t.length-1,1);switch(e){case"1":return t+"st";case"2":return t+"nd";case"3":return t+"rd";default:return t+"th"}},g=function(t){if(Math.floor(t)!==t)return t.toString();if(t>3)return"superb+"+(t-3);if(-3>t)return"terrible"+(t+3);switch(t){case 3:return"superb";case 2:return"great";case 1:return"good";case 0:return"fair";case-1:return"mediocre";case-2:return"poor";case-3:return"terrible"}},f=function(t,e){for(var i=0;i<e.content.length;++i){var n=e.content[i],o=n.min,a=n.max;if((void 0===o||t>=o)&&(void 0===a||a>=t))return void 0!==n.output?n.output:t.toString()}return t.toString()},m=function(){};m.prototype.beginGame=function(){},m.prototype.displayContent=function(t){},m.prototype.displayChoices=function(t){},m.prototype.displayGameOver=function(){this.displayContent(p("Game Over"))},m.prototype.removeChoices=function(){},m.prototype.beginOutput=function(){},m.prototype.endOutput=function(){},m.prototype.newPage=function(){},m.prototype.setStyle=function(t){},m.prototype.signal=function(t){},m.prototype.setBg=function(t){},m.prototype.setSprites=function(t){},m.prototype.setSpriteStyle=function(t,e){},m.prototype.audio=function(t){},m.makeParentOf=function(t){t.prototype=new m,t.constructor=t};var y=function(t,e){this.ui=t,this.game=e};y.prototype.displayGameOver=function(){return this.ui.displayGameOver(),this},y.prototype.displayChoices=function(){var e=this.getCurrentChoices();return t(e),this.ui.displayChoices(e),this.state.enableTranscript&&this.transcript.push(e),this},y.prototype.displaySceneContent=function(e){var i=this.getCurrentScene();t(i);var n=i.signal||this.game.sceneSignal;if(void 0!==n&&this.ui.signal({signal:n,event:"scene-display",id:this.state.sceneId}),e?(this.ui.newPage(),this.ui.displayContent(this.state.tempCurrentContent),this.state.currentContent=this.state.tempCurrentContent.slice()):i.newPage&&(this.ui.newPage(),this.state.currentContent=[]),this.ui.setStyle(i.style),this.ui.removeChoices(),void 0!==i.content&&!e){var o=this._makeDisplayContent(i.content,!0);this.state.enableTranscript&&(this.transcript=this.transcript.concat(o)),this.state.currentContent=this.state.currentContent.concat(o),this.ui.displayContent(o)}return this._runActions(i.onDisplay),this},y.prototype.choose=function(e){var i=this.choiceCache;if(t(i),i.length<=e)throw new Error("No choice at index "+e+", only "+i.length+" choices are available.");var n=i[e];if(!n.canChoose)throw new Error("Attempted to choose index "+e+", but that choice is unavailable.");var o=n.id;return this.state.enableTranscript&&this.transcript.push("> "+n.title),delete this.choiceCache,this.goToScene(o),this},y.prototype.goToScene=function(t){this.state.sceneIdsSinceGoTo=[],this.ui.beginOutput(),this.__changeScene(t),this.ui.endOutput()},y.prototype.beginGame=function(t){this.random=t?v.fromSeeds(t):v.fromUnique(),this.state={sceneId:null,sceneIdsSinceGoTo:[],rootSceneId:this.game.rootScene||this.game.firstScene||"root",gameOver:!1,visits:{},qualities:{},currentRandomState:null,currentContent:[],tempCurrentContent:[],prevSpecialSceneId:null,prevSceneId:null,prevTopSceneId:null,jumpSceneId:null,achievements:{},bg:null,sceneStack:[],justReturned:!1,justReturnedStart:!1,justReturnedEnd:!1,sprites:{},enableTranscript:!1},this.transcript=[],this._setUpQualities(),this._loadAchievements(),this.ui.beginGame();var e=this.game.firstScene||this.state.rootSceneId;return this.goToScene(e),this},y.prototype._loadAchievements=function(){if("undefined"!=typeof localStorage&&localStorage[this.game.title+"_achievements"]){this.state.achievements=JSON.parse(localStorage[this.game.title+"_achievements"]);for(var t in this.state.achievements)this.state.qualities["achievement_"+t]=1}},y.prototype.gameOver=function(){return this.state.gameOver=!0,this.displayGameOver(),this},y.prototype.isGameOver=function(){return this.state.gameOver},y.prototype.getCurrentScene=function(){var e=this.game.scenes[this.state.sceneId];return t(void 0!==e),e},y.prototype.getCurrentChoices=function(){return this.choiceCache},y.prototype.setState=function(t){if(this.state=t,this._setUpQualities(),this.random=v.fromState(this.state.currentRandomState),this._loadAchievements(),this.isGameOver())this.displayGameOver();else{var e=this.getCurrentScene();this.choiceCache=this._compileChoices(e),this.ui.newPage(),this.ui.removeChoices(),this.ui.displayContent(this.state.currentContent),this.displayChoices(),this.ui.setSprites(this.state.sprites),this.ui.setBg(this.state.bg)}return this},y.prototype.getExportableState=function(){return this.state},y.prototype._getQDisplay=function(e,i){switch(i){case"cardinal":case"number":return l(e);case"ordinal":return d(e);case"fudge":return g(e);default:var n=this.game.qdisplays[i];return t(void 0!==n),f(e,n)}},y.prototype._evaluateStateDependencies=function(e){for(var i=[],n=0;n<e.length;++n){var o,a=e[n],r=a.fn;switch(a.type){case"insert":o=this._runExpression(r),o=a.qdisplay?this._getQDisplay(o,a.qdisplay):o.toString();break;default:t("predicate"===a.type),o=this._runPredicate(r)}void 0!==o.stateDependencies&&(o=this._makeDisplayContent(o,!1)),i.push(o)}return i},y.prototype._mergeStateEvalsInArray=function(t,e){Array.isArray(t)||(t=[t]);for(var i=[],n=0;n<t.length;++n)i=i.concat(this._mergeStateEvals(t[n],e));return i},y.prototype._mergeStateEvals=function(t,e){if(void 0===t.type)return[t];var i;switch(t.type){case"conditional":i=e[t.predicate]?this._mergeStateEvalsInArray(t.content,e):[];break;case"insert":i=e[t.insert];break;default:var n={type:t.type};n.content=this._mergeStateEvalsInArray(t.content,e),i=[n]}return i},y.prototype._makeDisplayContent=function(t,e){if(void 0===t.content)return Array.isArray(t)?t:e?[{type:"paragraph",content:t}]:[t];if(void 0===t.stateDependencies&&void 0!==t.type)return[t];var i=t.stateDependencies,n=t.content;if(i&&i.length>0){var o=this._evaluateStateDependencies(i);Array.isArray(n)||(n=[n]),n=this._mergeStateEvalsInArray(n,o)}return n},y.prototype._setUpQualities=function(){var t=this._qualitiesAccessorsPrivate={},e=this.state.qualities,i=this;n(this.game.qualities,function(n,o){var a=o.min,r=o.max,s=o.signal||i.game.qualitySignal,c=o.isValid,h=void 0!==a||void 0!==r||void 0!==s||void 0!==c;h&&(void 0!==e[n]&&(t[n]=e[n]),e.__defineGetter__(n,function(){return t[n]}),e.__defineSetter__(n,function(e){void 0!==a&&a>e&&(e=a),void 0!==r&&e>r&&(e=r);var o=t[n];if(t[n]=e,i._runPredicate(c,!0)||(t[n]=e=o),void 0!==s&&e!==o){var h={signal:s,event:"quality-change",id:n,now:e};void 0!==o&&(h.was=o),i.ui.signal(h)}})),void 0!==o.initial&&void 0===e[n]&&(e[n]=o.initial)})},y.prototype._runActions=function(t){s(t,this,this.state)},y.prototype._runPredicate=function(t,e){return c(t,e,this,this.state)},y.prototype._runExpression=function(t,e){return h(t,e,this,this.state)},y.prototype.__changeScene=function(e){this.state.justReturned&&(this.state.justReturned=!1);var i=null,n=!1;if("prevScene"==e)null===this.prevSceneId,i=this.game.scenes[this.state.prevSceneId],e=this.state.prevSceneId,t(i);else if("prevTopScene"==e)i=this.game.scenes[this.state.prevTopSceneId],e=this.state.prevTopSceneId,t(i);else if("jumpScene"==e)i=this.game.scenes[this.state.jumpSceneId],e=this.state.jumpSceneId,t(i);else if("backSpecialScene"===e)i=this.game.scenes[this.state.prevSpecialSceneId],e=this.state.prevSpecialSceneId,n=!0,t(i),this.state.prevSpecialSceneId=null;else if("returnScene"==e){var o=this.state.sceneStack.pop();t(o),i=this.game.scenes[prevSceneId],this.state.justReturned=!0}else i=this.game.scenes[e],t(i);var a=this.state.sceneId;if(a){this.state.prevSceneId=a,i.isTop&&(this.state.prevTopSceneId=a),i.isSpecial&&null===this.state.prevSpecialSceneId&&(this.state.tempCurrentContent=this.state.currentContent.slice(),this.state.prevSpecialSceneId=a);var r=this.getCurrentScene();this._runActions(r.onDeparture);var s=r.signal||this.game.sceneSignal;void 0!==s&&this.ui.signal({signal:s,event:"scene-departure",id:this.state.sceneId,to:e})}this.state.sceneId=e,this.state.sceneIdsSinceGoTo.push(e),i.setRoot&&(this.state.rootSceneId=e),i.setJump&&(this.state.jumpSceneId=i.setJump),void 0!==i.countVisitsMax&&(void 0===this.state.visits[e]?this.state.visits[e]=1:this.state.visits[e]<i.countVisitsMax&&this.state.visits[e]++),n||this.state.justReturned||this._runActions(i.onArrival);var c=i.signal||this.game.sceneSignal;if(void 0!==c){var h={signal:c,event:"scene-arrival",id:e};a&&(h.from=a),this.ui.signal(h)}this.state.currentRandomState=this.random.getState(),this.displaySceneContent(n),i.setBg&&(this.state.bg=i.setBg,this.ui.setBg(i.setBg)),i.setSprites&&(this.state.sprites=i.setSprites,this.ui.setSprites(i.setSprites)),i.audio&&this.ui.audio(i.audio),i.setTopLeftStyle&&this.ui.setSpriteStyle("topLeft",i.setTopLeftStyle),i.setTopRightStyle&&this.ui.setSpriteStyle("topRight",i.setTopRightStyle),i.setBottomLeftStyle&&this.ui.setSpriteStyle("bottomLeft",i.setBottomLeftStyle),i.setBottomRightStyle&&this.ui.setSpriteStyle("bottomRight",i.setBottomRightStyle),i.achievement&&(this.state.achievements[i.achievement]=1,this.state.qualities["achievement_"+i.achievement]=1,"undefined"!=typeof localStorage&&(localStorage[this.game.title+"_achievements"]=JSON.stringify(this.state.achievements)));var u=!1;if(i.gameOver===!0)u=!0,this.gameOver();else if(i.goSubEnd&&!this.state.justReturnedEnd)for(var p=[],l=0;l<i.goSub.length;++l){var d=i.goSub[l];(void 0===d.predicate||this._runPredicate(d.predicate))&&p.push(d.id)}else if(i.goTo){for(var g=[],f=0;f<i.goTo.length;++f){var m=i.goTo[f];(void 0===m.predicate||this._runPredicate(m.predicate))&&g.push(m.id)}if(1===g.length)u=!0,this.__changeScene(g[0]);else if(g.length>1){var y=this.random.uint32(),v=y%g.length,_=g[v];u=!0,this.__changeScene(_)}}else if(i.goToRef){for(var b=[],S=0;S<i.goToRef.length;++S){var w=i.goToRef[S];(void 0===w.predicate||this._runPredicate(w.predicate))&&b.push(w.id)}if(1===b.length)u=!0,this.__changeScene(this.state.qualities[b[0]]);else if(b.length>1){var k=this.random.uint32()%b.length,C=b[k];u=!0,this.__changeScene(this.state.qualities[C])}}u||(this.choiceCache=this._compileChoices(i),null===this.choiceCache?i.gameOver!==!1&&this.gameOver():this.displayChoices())},y.prototype.__getChoiceSelectionData=function(t){var e=[];for(var i in t){var n=this.game.scenes[i],o=t[i];o.order=o.order||n.order||0,o.priority=o.priority||n.priority||1,void 0===o.frequency&&(o.frequency=n.frequency,void 0===o.frequency&&(o.frequency=100)),o.selectionPriority=0,e.push(o)}return e},y.prototype.__filterViewable=function(t){var e={};for(var i in t){var n=this.game.scenes[i],o=n.maxVisits;if(void 0!==o){var a=this.state.visits[i]||0;if(a>=o)continue}var r=this._runPredicate(n.viewIf,!0);r&&(e[i]=t[i])}return e},y.prototype.__getChoiceIdsFromOptions=function(e){var a=this,r={};return i(e,function(e){if(a._runPredicate(e.viewIf,!0))if("@"===e.id.substr(0,1)){var i=e.id.substring(1),s=o(e,{id:i});r[i]=s}else{t("#"===e.id.substr(0,1));var c=a.game.tagLookup[e.id.substring(1)];n(c,function(t){void 0===r[t]&&(r[t]=o(e,{id:t}))})}}),r},y.prototype.__filterByPriority=function(e,n,o){t(null===n||null===o||o>=n);var a,r=this,s=[],c=[];e.sort(function(t,e){return e.priority-t.priority});for(var h,u=0;u<e.length;++u){if(a=e[u],a.priority!==h){if(void 0!==h&&(null===n||u>=n))break;s.push.apply(s,c),c=[],h=a.priority}c.push(a)}var p=s.length,l=p+c.length;if(null===o||o>=l)s.push.apply(s,c);else{i(c,function(t){null===t.frequency?t.selectionPriority=0:t.selectionPriority=r.random.random()/t.frequency}),c.sort(function(t,e){return t.selectionPriority-e.selectionPriority});var d=o-p,g=c.slice(0,d);s.push.apply(s,g)}return s},y.prototype.__getChoiceDisplayData=function(e){for(var i=[],n=0,o=0;o<e.length;++o){var a=e[o],r=this.game.scenes[a.id],s=!0;a.chooseIf&&(s=this._runPredicate(a.chooseIf,!0)),s&&r.chooseIf&&(s=this._runPredicate(r.chooseIf,!0));var c=a.title||r.title;t(c);var h=null;s||(h=a.unavailableSubtitle||r.unavailableSubtitle),h||(h=a.subtitle||r.subtitle);var u={id:a.id,canChoose:s,title:this._makeDisplayContent(c,!1)};h&&(u.subtitle=this._makeDisplayContent(h,!1)),i.push(u),s&&++n}return{choices:i,numChoosable:n}},y.prototype._compileChoices=function(e){t(e);var i=e.options,n=[],o=0;if(void 0!==i){var a=this.__getChoiceIdsFromOptions(i);a=this.__filterViewable(a);var r=this.__getChoiceSelectionData(a),s=e.minChoices||null,c=e.maxChoices||null;r=this.__filterByPriority(r,s,c),r.sort(function(t,e){return t.order-e.order});var h=this.__getChoiceDisplayData(r);n=h.choices,o=h.numChoosable}if(0===o){var u=this.state.rootSceneId;if(u!==this.state.sceneId){var p=this.game.scenes[u].chooseIf;(!p||this._runPredicate(p,!0))&&(n.push({id:u,title:"Continue...",canChoose:!0}),++o)}}return o>0?n:null};var v=function(t,e,i,n,o){this.getState=function(){return[t,e,i,n,o]};var a=function(t,e){var i=t>>16&65535,n=65535&t,o=e>>16&65535,a=65535&e,r=i*a+n*o&65535;return(r<<16>>>0)+n*a};this.uint32=function(){var r=(i^i>>>7)>>>0;return i=n,n=o,o=e,e=t,t=t^t<<6^(r^r<<13)>>>0,a(n+n+1,t)>>>0},this.random=function(){return 2.3283064365386963e-10*this.uint32()}},_=1;v.fromUnique=function(){var t=(new Date).getTime();return v.fromSeeds([t,_++])},v.fromTime=function(){return v.fromSeeds([(new Date).getTime()])},v.fromSeeds=function(t){for(var e=886756453,i=88675123,n=123456789,o=362436069,a=521288629,r=function(t){t=t.toString();for(var e=4022871197,i=0;i<t.length;i++){e+=t.charCodeAt(i);var n=.02519603282416938*e;e=n>>>0,n-=e,n*=e,e=n>>>0,n-=e,e+=4294967296*n}return 2.3283064365386963e-10*(e>>>0)},s=0;s<t.length;s++){var c=4294967296*r(t[s]);e^=c,i^=c,n^=c,o^=c,a^=c}return new v(e,i,n,o,a)},v.fromState=function(t){return new v(t[0],t[1],t[2],t[3],t[4])},e.exports={makeFunctionFromSource:r,runActions:s,runPredicate:c,runExpression:h,convertJSONToGame:u,simpleContent:p,getCardinalNumber:l,getOrdinalNumber:d,getUserQDisplay:f,getFudgeDisplay:g,DendryEngine:y,UserInterface:m,NullUserInterface:m,Random:v}}()},{}],2:[function(t,e,i){!function(e){"use strict";var i=t("./content/html"),n=t("../engine"),o=function(t,e){this.game=t,this.$content=e,this._registerEvents(),this.dendryEngine=new n.DendryEngine(this,t),this.hasSidebar=!1,this.sidebarQualities=[],this.base_settings={disable_bg:!1,animate:!1,animate_bg:!0,disable_audio:!1,show_portraits:!0},this.disable_bg=!1,this.animate=!1,this.animate_bg=!0,this.disable_audio=!1,this.show_portraits=!0,this.fade_time=600,this.bg_fade_out_time=200,this.bg_fade_in_time=1e3,this.sound_fade_time=2e3,this.contentToHTML=i,this.spriteLocs={topLeft:1,topRight:1,bottomLeft:1,bottomRight:1},this.currentAudio=null,this.currentAudioURL="",this.audioQueue=[],this.onNewPage=!1,this.save_prefix=t.title+"_"+t.author+"_save",this.max_slots=8,this.DateOptions={hour:"numeric",minute:"numeric",second:"numeric",year:"numeric",month:"short",day:"numeric"}};n.UserInterface.makeParentOf(o),o.prototype.displayContent=function(t){var n=e(i.convert(t));this.animate?(n.fadeIn(this.fade_time),this.$content.append(n)):this.$content.append(n),n.focus(),window&&window.onDisplayContent&&window.onDisplayContent()},o.prototype.displayGameOver=function(){var t=e("<p>").text(this.getGameOverMsg()).addClass("game-over");this.animate?(t.fadeIn(this.fade_time),this.$content.append(t)):this.$content.append(t),t.focus()},o.prototype.displayChoices=function(t){for(var n=e("<ul>").addClass("choices"),o=0;o<t.length;++o){var a=t[o],r=i.convertLine(a.title),s="";void 0!==a.subtitle&&(s=i.convertLine(a.subtitle));var c=e("<li>"),h=c;a.canChoose?(h=e("<a>").attr({href:"#","data-choice":o}),c.html(h)):h.addClass("unavailable"),h.html(r),s&&c.append(e("<div>").addClass("subtitle").html(s)),n.append(c)}this.animate?(n.fadeIn(this.fade_time),this.$content.append(n)):this.$content.append(n),n.focus(),this.onNewPage&&(this.onNewPage=!1,window&&window.onNewPage&&window.onNewPage())},o.prototype.newPage=function(){if(this.animate){this.$content;this.$content.empty(),this.$content.children().fadeOut(this.fade_time,function(){})}else this.$content.empty();this.onNewPage=!0},o.prototype.setStyle=function(t){this.$content.removeClass(),void 0!==t&&this.$content.addClass(t)},o.prototype.removeChoices=function(){e(".choices",this.$content).remove(),e(".hidden",this.$content).remove()},o.prototype.beginOutput=function(){e("#read-marker",this.$content).remove(),this.$content.append(e("<hr>").attr("id","read-marker"))},o.prototype.endOutput=function(){var t=e("#read-marker");this.animate&&(t.length>0?e("html, body").animate({scrollTop:t.offset().top},this.fade_time):e("html, body").animate({scrollTop:0},this.fade_time))},o.prototype.signal=function(t){console.log(t);var e=t.signal,i=t.event,n=t.id;window&&window.handleSignal&&window.handleSignal(e,i,n)},o.prototype.setBg=function(t){this.disable_bg?(e("#bg1").addClass("content_hidden"),e("#bg1").removeClass("content_visible"),e("#bg1").css("background-image","none")):t&&"none"!=t&&"null"!=t?t.startsWith("#")||t.startsWith("rgba(")||t.startsWith("rgb(")?this.animate_bg?(e("#bg1").fadeOut(this.bg_fade_out_time,function(){e("#bg1").css("background-image","none"),e("#bg1").css("background-color",t)}),e("#bg1").fadeIn(this.bg_fade_in_time,function(){e("#bg2").css("background-image","none")}),console.log("changing background color "+t)):(e("#bg1").css("background-image","none"),e("#bg1").css("bacground-color",t)):t.startsWith("linear-gradient(")?this.animate_bg?(e("#bg1").fadeOut(this.bg_fade_out_time,function(){e("#bg1").css("background-image",t)}),e("#bg1").fadeIn(this.bg_fade_in_time,function(){e("#bg2").css("background-image",t)}),console.log("changing background gradient "+t)):e("#bg1").css("background-image",t):this.animate_bg?(e("#bg1").fadeOut(this.bg_fade_out_time,function(){e("#bg1").css("background-image",'url("'+t+'")')}),e("#bg1").fadeIn(this.bg_fade_in_time,function(){e("#bg2").css("background-image",e("#bg1").css("background-image"))})):e("#bg1").css("background-image",'url("'+t+'")'):this.animate_bg?(e("#bg1").addClass("content_hidden"),e("#bg1").removeClass("content_visible"),setTimeout(function(){e("#bg1").css("background-image","none"),e("#bg1").removeClass("content_hidden"),e("#bg1").addClass("content_visible")},100)):e("#bg1").css("background-image","none")},o.prototype.setSprites=function(t){if(window&&window.setSprites)return void window.setSprites(t);if(!this.show_portraits||"none"==t||"clear"==t)return e("#topLeftSprite").children().fadeOut(this.fade_time,function(){e("#topLeftSprite").empty()}),e("#topRightSprite").children().fadeOut(this.fade_time,function(){e("#topRightSprite").empty()}),e("#bottomLeftSprite").children().fadeOut(this.fade_time,function(){e("#bottomLeftSprite").empty()}),void e("#bottomRightSprite").children().fadeOut(this.fade_time,function(){e("#bottomRightSprite").empty()});if(t instanceof Array)for(var i=0;i<t.length;i++){var n=t[i][0],o=t[i][1];this.setSprite(n,o)}else if(t)for(var a in Object.keys(t))sprites.push([a,t[a]])},o.prototype.setSprite=function(t,i){if(this.show_portraits){if(window&&window.setSprite)return void window.setSprite(t,i);t=t.toLowerCase();var n;return"topleft"==t?n=e("#topLeftSprite"):"topright"==t?n=e("#topRightSprite"):"bottomleft"==t?n=e("#bottomLeftSprite"):"bottomright"==t&&(n=e("#bottomRightSprite")),"none"==i||"clear"==i?(delete this.dendryEngine.state.sprites[t],void n.fadeOut(this.fade_time,function(){n.empty()})):(this.dendryEngine.state.sprites[t]=i,void n.fadeOut(this.fade_time,function(){n.emtpy();var t=new Image;t.src=i,n.append(t),console.log("fadeIn"),n.fadeIn(this.fade_time)}))}},o.prototype.setSpriteStyle=function(t,i){if(window&&window.setSpriteStyle)return void window.setSpriteStyle(t,i);var n;if("topleft"==t)n=e("#topLeftSprite");else if("topright"==t)n=e("#topRightSprite");else if("bottomleft"==t)n=e("#bottomLeftSprite");else{if("bottomright"!=t)return;n=e("#bottomRightSprite")}n.css(i)},o.prototype.audio=function(t){if(this.disable_audio)return void(this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.loop=!1));var i=t.split(" "),n=i.includes("loop"),o=i.includes("queue"),a=i.includes("nofade"),r=i[0],s=this.currentAudio,c=this.sound_fade_time;if("null"==r||"none"==r)this.currentAudio&&(e(s).animate({volume:0},this.sound_fade_time,function(){s.pause()}),this.currentAudio.loop=!1);else{if(console.log("new audio:",r,"current audio:",this.currentAudioURL),this.currentAudio&&(this.currentAudioURL==r||o))if(s.ended||s.paused)this.currentAudioURL=r,
s.src=r,console.log("Fading in new audio"),s.volume=0,s.play(),e(s).animate({volume:1},c);else{console.log("adding music to queue"),this.audioQueue=[r];var h=this.audioQueue;this.currentAudio.onended=function(){var t=h.pop();t&&(s.src=t,console.log("playing from queue"),s.play(),e(s).animate({volume:1},c),window.dendryUI.currentAudioURL=t)}}else this.currentAudio?(this.currentAudioURL=r,console.log("currentAudio present,  fading out current audio"),s.onended=function(){},a?(s.pause(),s.src=r,s.play()):e(s).animate({volume:0},this.sound_fade_time,function(){console.log(s),s.src=r,console.log("Fading in new audio"),s.play(),e(s).animate({volume:1},c)})):(this.currentAudio=new Audio(r),this.currentAudio.volume=0,this.currentAudio.play(),e(this.currentAudio).animate({volume:1},this.sound_fade_time));n?this.currentAudio.loop=!0:this.currentAudio.loop=!1}},o.prototype.saveSettings=function(){"undefined"!=typeof localStorage&&(localStorage[this.game.title+"_animate"]=this.animate,localStorage[this.game.title+"_disable_bg"]=this.disable_bg,localStorage[this.game.title+"_animate_bg"]=this.animate_bg,localStorage[this.game.title+"_show_portraits"]=this.show_portraits,localStorage[this.game.title+"_disable_audio"]=this.disable_audio)},o.prototype.loadSettings=function(t){"undefined"!=typeof localStorage&&(localStorage[this.game.title+"_animate"]?this.animate="false"!=localStorage[this.game.title+"_animate"]||!1:t&&t.animate?this.animate=t.animate:this.animate=!1,localStorage[this.game.title+"_disable_bg"]?this.disable_bg="false"!=localStorage[this.game.title+"_disable_bg"]||!1:t&&t.disable_bg?this.disable_bg=t.disable_bg:this.disable_bg=!1,localStorage[this.game.title+"_animate_bg"]?this.animate_bg="false"!=localStorage[this.game.title+"_animate_bg"]||!1:t&&t.animate_bg?this.animate_bg=t.animate_bg:this.animate_bg=!0,localStorage[this.game.title+"_show_portraits"]?this.show_portraits="false"!=localStorage[this.game.title+"_show_portraits"]||!1:t&&t.show_portraits?this.show_portraits=t.show_portraits:this.show_portraits=!0,localStorage[this.game.title+"_disable_audio"]?this.disable_audio="false"!=localStorage[this.game.title+"_disable_audio"]||!1:t&&t.disable_audio?this.disable_audio=t.disable_audio:this.disable_audio=!1)},o.prototype.toggle_audio=function(t){t?this.disable_audio=!1:(this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.loop=!1),this.disable_audio=!0)},o.prototype.autosave=function(){var t=localStorage[this.save_prefix+"_a0"];t&&(localStorage[this.save_prefix+"_a1"]=t,localStorage[this.save_prefix+"_timestamp_a1"]=localStorage[this.save_prefix+"_timestamp_a0"]);var e="a0",i=JSON.stringify(this.dendryEngine.getExportableState());localStorage[this.save_prefix+"_"+e]=i;var n=this.dendryEngine.state.sceneId,o=new Date(Date.now());o=n+"\n("+o.toLocaleString(void 0,this.DateOptions)+")",localStorage[this.save_prefix+"_timestamp_"+e]=o,this.populateSaveSlots(e+1,2)},o.prototype.quickSave=function(){var t=JSON.stringify(this.dendryEngine.getExportableState());localStorage[this.save_prefix+"_q"]=t,window.alert("Saved.")},o.prototype.saveSlot=function(t){var e=JSON.stringify(this.dendryEngine.getExportableState());localStorage[this.save_prefix+"_"+t]=e;var i=this.dendryEngine.state.sceneId,n=new Date(Date.now());n=i+"\n("+n.toLocaleString(void 0,this.DateOptions)+")",localStorage[this.save_prefix+"_timestamp_"+t]=n,this.populateSaveSlots(t+1,2)},o.prototype.quickLoad=function(){if(localStorage[this.save_prefix+"_q"]){var t=localStorage[this.save_prefix+"_q"];this.dendryEngine.setState(JSON.parse(t)),window.alert("Loaded.")}else window.alert("No save available.")},o.prototype.loadSlot=function(t){if(localStorage[this.save_prefix+"_"+t]){var e=localStorage[this.save_prefix+"_"+t];this.dendryEngine.setState(JSON.parse(e)),this.hideSaveSlots(),window.alert("Loaded.")}else window.alert("No save available.")},o.prototype.deleteSlot=function(t){localStorage[this.save_prefix+"_"+t]?(localStorage[this.save_prefix+"_"+t]="",localStorage[this.save_prefix+"_timestamp_"+t]="",this.populateSaveSlots(t+1,2)):window.alert("No save available.")},o.prototype.populateSaveSlots=function(t,e){function i(t){return function(e){r.loadSlot(t)}}function n(t){return function(e){r.saveSlot(t)}}function o(t){return function(e){r.deleteSlot(t)}}function a(t){var e=document.getElementById("save_info_"+t),a=document.getElementById("save_button_"+t),s=document.getElementById("delete_button_"+t);if(localStorage[r.save_prefix+"_"+t]){var c=localStorage[r.save_prefix+"_timestamp_"+t];e.textContent=c,a.textContent="Load",a.onclick=i(t),s.onclick=o(t)}else a.textContent="Save",e.textContent="Empty",a.onclick=n(t)}for(var r=this,s=0;t>s;s++)a(s);for(s=0;e>s;s++)a("a"+s)},o.prototype.showSaveSlots=function(){var t=document.getElementById("save");t.style.display="block",this.populateSaveSlots(this.max_slots,2);var e=this;t.onclick||(t.onclick=function(t){var i=t.target,n=document.getElementById("save");i==n&&e.hideSaveSlots()})},o.prototype.hideSaveSlots=function(){var t=document.getElementById("save");t.style.display="none"},o.prototype.setOption=function(t,e){this[t]=e,this.saveSettings()},o.prototype.populateOptions=function(){var t=this.disable_bg,i=this.animate,n=this.animate_bg;t?e("#backgrounds_no")[0].checked=!0:e("#backgrounds_yes")[0].checked=!0,i?e("#animate_yes")[0].checked=!0:e("#animate_no")[0].checked=!0,n?e("#animate_bg_yes")[0].checked=!0:e("#animate_bg_no")[0].checked=!0},o.prototype.showOptions=function(){var t=document.getElementById("options");this.populateOptions(),t.style.display="block",t.onclick||(t.onclick=function(t){var e=t.target,i=document.getElementById("options");e==i&&this.hideOptions()})},o.prototype.getGameOverMsg=function(){return"Game Over (reload to read again)"},o.prototype._registerEvents=function(){var t=this;this.$content.on("click","ul.choices li a",function(i){i.preventDefault(),i.stopPropagation();var n=parseInt(e(this).attr("data-choice"));return t.dendryEngine.choose(n),!1}),this.$content.on("click","ul.choices li",function(t){return t.preventDefault(),t.stopPropagation(),e("a",this).click(),!1})};var a=function(){n.convertJSONToGame(window.game.compiled,function(t,i){if(t)throw t;var n=new o(i,e("#content"));if(window.dendryUI=n,void 0!==window.dendryModifyUI){var a=window.dendryModifyUI(n);if(a)return}n.dendryEngine.beginGame()})};e(a)}(jQuery)},{"../engine":1,"./content/html":3}],3:[function(t,e,i){!function(){"use strict";var t=function(t){if(void 0===t.type)return"undefined"!=typeof window&&window.displayText&&(t=window.displayText(t)),t;switch(t.type){case"emphasis-1":return"<em>"+i(t.content)+"</em>";case"emphasis-2":return"<strong>"+i(t.content)+"</strong>";case"emphasis-3":return"<code>"+i(t.content)+"</code>";case"hidden":return'<span class="hidden">'+i(t.content)+"</span>";case"line-break":return"<br>";case"magic":return t.content;case"insert":case"conditional":throw new Error(t.type+" should have been evaluated by now.")}},i=function(e){if(Array.isArray(e)){for(var i=[],n=0;n<e.length;++n){var o=e[n];i.push(t(o))}return i.join("")}return t(e)},n=function(t){for(var e=[],n=0;n<t.length;++n){var o=t[n];switch(o.type){case"heading":e.push("<h1>"),e.push(i(o.content)),e.push("</h1>");break;case"paragraph":e.push("<p>"),e.push(i(o.content)),e.push("</p>");break;case"quotation":e.push("<blockquote>"),e.push(i(o.content)),e.push("</blockquote>");break;case"attribution":e.push('<blockquote class="attribution">'),e.push(i(o.content)),e.push("</blockquote>");break;case"magic":e.push(o.content);break;case"hrule":e.push("<hr>")}}return e.join("")};e.exports={convert:n,convertLine:i}}()},{}]},{},[2]);